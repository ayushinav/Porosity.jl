name: Documenter

on:
  push:
    branches:
      - main
    tags: ['*']
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write
  statuses: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: [1.11, 1.12]  # adjust Julia versions if needed
    steps:
      # 1. Checkout repository
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Delete docs Manifest (important for unregistered packages)
      - name: Delete docs Manifest
        run: rm -f docs/Manifest.toml

      # 3. Setup Julia
      - name: Setup Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: ${{ matrix.version }}

      # 4. Cache Julia packages
      - name: Load Julia packages from cache
        id: julia-cache
        uses: julia-actions/cache@v2

      # 5. Activate docs env and develop packages
      - name: Load Porosity.jl and SubsurfaceCore.jl
        run: |
          julia -e '
            using Pkg;
            Pkg.activate("docs");

            # develop main package (Porosity)
            Pkg.develop(PackageSpec(path=pwd()));

            # develop dependency (SubsurfaceCore)
            Pkg.develop(url="https://github.com/ayushinav/SubsurfaceCore.jl.git");

            # instantiate docs environment
            Pkg.instantiate();
          '

      # 6. Build and deploy docs
      - name: Build and deploy docs
        uses: julia-actions/julia-docdeploy@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DOCUMENTER_KEY: ${{ secrets.DOCUMENTER_KEY }}
          JULIA_DEBUG: "Documenter"
          DATADEPS_ALWAYS_ACCEPT: true

      # 7. Optional: save Julia cache on failure or cancel
      - name: Save Julia depot cache on cancel or failure
        id: julia-cache-save
        if: cancelled() || failure()
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ steps.julia-cache.outputs.cache-paths }}
          key: ${{ steps.julia-cache.outputs.cache-key }}
