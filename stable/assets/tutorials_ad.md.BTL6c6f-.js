import{_ as i,c as a,o as e,an as n}from"./chunks/framework.D8qffib8.js";const c=JSON.parse('{"title":"Automatic Differentiation","description":"","frontmatter":{},"headers":[],"relativePath":"tutorials/ad.md","filePath":"tutorials/ad.md","lastUpdated":null}'),t={name:"tutorials/ad.md"};function p(l,s,h,o,d,r){return e(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="Automatic-Differentiation" tabindex="-1">Automatic Differentiation <a class="header-anchor" href="#Automatic-Differentiation" aria-label="Permalink to &quot;Automatic Differentiation {#Automatic-Differentiation}&quot;">​</a></h1><h2 id="Example" tabindex="-1">Example <a class="header-anchor" href="#Example" aria-label="Permalink to &quot;Example {#Example}&quot;">​</a></h2><p>We can compute derivatives of the models used in the package using AD (<a href="https://en.wikipedia.org/wiki/Automatic_differentiation" target="_blank" rel="noreferrer">automatic differentiation</a>). While the functionalities that require AD are built-in, we demonstrate below how the derivatives can be explicitly obtained. We take the example of <a href="/Porosity.jl/stable/models/conductivity#UHO2014"><code>UHO2014</code></a> which estimates conductivity of olivine depending on temperature and water content.</p><p>Let&#39;s first define the model</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">m </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> UHO2014</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Model : UHO2014</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Temperature (K) : 1000.0</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Water concentration in olivine (ppm) : 100.0</span></span></code></pre></div><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">resp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> forward</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(m, [])</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Rock physics Response : RockphyCond</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">log₁₀ conductivity (S/m) : -3.574135982314401</span></span></code></pre></div><p>For AD, we use the <a href="https://juliadiff.org/DifferentiationInterface.jl/DifferentiationInterface/stable/" target="_blank" rel="noreferrer"><code>DifferentiationInterface</code></a> library with <a href="https://enzyme.mit.edu/julia/stable/" target="_blank" rel="noreferrer"><code>Enzyme</code></a> backend.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>using DifferentiationInterface, Enzyme</span></span>
<span class="line"><span></span></span>
<span class="line"><span>f(T) = forward(UHO2014(T, 100.) , []).σ</span></span>
<span class="line"><span>ad_wrt_T = derivative(f, AutoEnzyme(), 1000.)</span></span></code></pre></div><p>Let&#39;s verify that using finite differences :</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>fd_wrt_T = 0.5 * (f(1001.) - f(999.))</span></span></code></pre></div><p>Similarly, we can do the same for water content :</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>f(Cw) = forward(UHO2014(1000., Cw) , []).σ</span></span>
<span class="line"><span>ad_wrt_Cw = derivative(f, AutoEnzyme(), 100.)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>fd_wrt_Cw = 0.5 * (f(101.) - f(99.))</span></span></code></pre></div><p>If you can imagine the input as a vector, you can obtain the gradient to get the derivative in one step :</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>function f(p)</span></span>
<span class="line"><span>    T = p[1]</span></span>
<span class="line"><span>    Cw = p[2]</span></span>
<span class="line"><span>    forward(UHO2014(T, Cw) , []).σ</span></span>
<span class="line"><span>end</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ad_p = DifferentiationInterface.gradient(f, AutoEnzyme(), [1000., 100.])</span></span></code></pre></div><div class="info custom-block"><p class="custom-block-title">If you need derivatives explicitly, it is recommended to check out <code>DifferentiationInterface.jl</code> more thoroughly, especially the mutating counterparts (<code>derivative!</code> and <code>gradient!</code>). :::</p><h2 id="A-bit-of-caution" tabindex="-1">A bit of caution <a class="header-anchor" href="#A-bit-of-caution" aria-label="Permalink to &quot;A bit of caution {#A-bit-of-caution}&quot;">​</a></h2><p>Please note that you would not need to compute the derivatives in most cases. If you are using a neural network you can just plug the forward model in front of the network to train it. This page is to show the compatibility of the code for automatic differentiation.</p><p>An MWE (minimal working example) for such a model would be :</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Porosity, Lux</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(p)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    T </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, :]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Cw </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, :]</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    forward</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">UHO2014</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(T, Cw), [])</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">σ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">nn </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Chain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Dense</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, tanh), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Dense</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, tanh), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Dense</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), f)</span></span></code></pre></div><p>The above network can then be trained by using the same instructions as for training a <code>Lux</code> network.</p></div>`,18)])])}const g=i(t,[["render",p]]);export{c as __pageData,g as default};
